
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Attendance View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="/assets/js/auth-gate.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .day-button.selected {
      background-color: #2563eb;
      color: white;
    }
    .block-btn {
      min-width: 20px;
      height: 20px;
      margin: 1px;
      border-radius: 3px;
    }
    .block-A { background-color: #dc2626; }
    .block-P { background-color: #16a34a; }
    .block-L { background-color: #facc15; color: black; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Header -->
  <header class="bg-gray-800 p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Employee Attendance - Date View</h1>
  </header>

  <!-- Date & Month Selector -->
  <div class="p-4 text-center">
    <div class="flex flex-wrap justify-center gap-1 mb-2" id="monthSelector">
      <!-- Months -->
      <script>
        const months = ["January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"];
        const now = new Date();
        months.forEach((m, i) => {
          document.write(`<button class="bg-gray-700 text-white px-2 py-1 rounded">${m} 2025</button>`);
        });
      </script>
    </div>
    <div class="flex flex-wrap justify-center gap-1" id="daySelector">
      <!-- Days -->
      <script>
        for (let d = 1; d <= 31; d++) {
          document.write(`<button id="day-${d}" class="day-button bg-gray-700 text-gray-300 px-2 py-1 rounded" onclick="handleDayClick(${d})">${d}</button>`);
        }
      </script>
    </div>
    <div class="mt-2">
      <button onclick="jumpToToday()" class="bg-blue-500 px-3 py-1 text-white text-xs rounded">Today</button>
    </div>
  </div>

  <!-- Attendance Grid -->
  <main class="p-4 space-y-6" id="attendanceContainer">
    <!-- JS will inject employee rows here -->
  </main>

  <script>
  let currentDay = new Date().getDate();
  let mouseDown = false;
  let dragStatus = "P";
  const selectedDateBlocks = {}; // { emp_id: ["A", "P", ...] }
  let employees = [];

  document.addEventListener("mousedown", () => mouseDown = true);
  document.addEventListener("mouseup", () => mouseDown = false);

  function handleDayClick(day) {
    currentDay = day;
    document.querySelectorAll('.day-button').forEach(btn => btn.classList.remove('selected'));
    document.getElementById("day-" + day).classList.add('selected');
    renderAttendanceGrid();
  }

  function jumpToToday() {
    handleDayClick(new Date().getDate());
  }

  function toggleStatus(btn, empId, blockIndex) {
    const states = ["A", "P", "L"];
    const current = btn.dataset.state;
    const next = states[(states.indexOf(current) + 1) % 3];
    btn.dataset.state = next;
    btn.className = `block-btn block-${next}`;
    selectedDateBlocks[empId][blockIndex] = next;
    updateSummary(empId);
  }

  function dragApply(btn, empId, blockIndex) {
    if (!mouseDown) return;
    btn.dataset.state = dragStatus;
    btn.className = `block-btn block-${dragStatus}`;
    selectedDateBlocks[empId][blockIndex] = dragStatus;
    updateSummary(empId);
  }

  function updateSummary(empId) {
    const blocks = selectedDateBlocks[empId] || [];
    const summary = { A: 0, P: 0, L: 0 };
    blocks.forEach(s => summary[s]++);
    document.getElementById("summary-" + empId).textContent =
      `Present: ${summary.P} | Leave: ${summary.L} | Absent: ${summary.A}`;
  }

  function renderAttendanceGrid() {
    const container = document.getElementById("attendanceContainer");
    container.innerHTML = "";

    employees.forEach(emp => {
      const blocks = selectedDateBlocks[emp.emp_id] || Array(48).fill("A");
      selectedDateBlocks[emp.emp_id] = blocks;

      const row = document.createElement("div");
      row.className = "bg-gray-800 p-4 rounded shadow";

      const name = document.createElement("div");
      name.className = "mb-2 font-semibold";
      name.innerText = `Name: ${emp.name} | Role: ${emp.role} | Department: ${emp.department}`;
      row.appendChild(name);

      const blockWrap = document.createElement("div");
      blockWrap.className = "flex flex-wrap gap-1 mb-2";

      for (let i = 0; i < 48; i++) {
        const b = document.createElement("button");
        b.className = `block-btn block-${blocks[i]}`;
        b.dataset.state = blocks[i];
        b.innerText = "";
        b.onclick = () => toggleStatus(b, emp.emp_id, i);
        b.onmouseover = () => dragApply(b, emp.emp_id, i);
        blockWrap.appendChild(b);
      }

      const summary = document.createElement("div");
      summary.className = "text-sm text-gray-400 mb-2";
      summary.id = "summary-" + emp.emp_id;
      row.appendChild(blockWrap);
      row.appendChild(summary);
      updateSummary(emp.emp_id);

      const confirm = document.createElement("button");
      confirm.innerText = "Confirm Changes";
      confirm.className = "bg-indigo-600 hover:bg-indigo-700 px-4 py-1 text-sm rounded";
      confirm.onclick = () => {
        const status = selectedDateBlocks[emp.emp_id];
        const payload = {
          emp_id: emp.emp_id,
          year: 2025,
          month: 7,
          day: currentDay,
          slots: status.map((s, i) => ({ slot: i, status: s }))
        };

        fetch('/.netlify/functions/update_attendance', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => alert(data.message || data.error))
        .catch(err => {
          console.error("âŒ Update error:", err);
          alert("Update failed");
        });
      };
      row.appendChild(confirm);

      container.appendChild(row);
    });
  }

  // Initial fetch
  async function loadAttendance() {
    const res = await fetch('/.netlify/functions/get_attendance_calendar?year=2025&month=7');
    const { data } = await res.json();
    employees = data;
    data.forEach(emp => {
      const blocks = emp.status[currentDay - 1] || Array(48).fill("A");
      selectedDateBlocks[emp.emp_id] = blocks;
    });
    handleDayClick(currentDay);
  }

  loadAttendance();
</script>

</body>
</html>
