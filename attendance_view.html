<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance View - Nikagenyx</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Questrial', sans-serif; }
    .day-label { width: 24px; text-align: center; font-size: 10px; color: #ccc; }
    .half-hour-box {
      width: 6px;
      height: 24px;
      display: inline-block;
      margin: 0 0.5px;
      background-color: #4b5563; /* Default for NA */
    }
    .P { background-color: #16a34a; }  /* Present */
    .A { background-color: #dc2626; }  /* Absent */
    .L { background-color: #facc15; }  /* Leave */
    .H { background-color: #3b82f6; }  /* Holiday */
    .NA { background-color: #374151; } /* Not Available */
    .month-btn { padding: 6px 12px; border-radius: 4px; }
    .active-month { background-color: #4f46e5; }
  </style>
</head>
<body class="bg-gray-900 text-white p-6">

  <h1 class="text-3xl font-bold mb-6 text-center">üìÖ Employee Attendance Viewer</h1>
  <div class="flex justify-center flex-wrap gap-2 mb-6" id="monthSelector"></div>
  <div id="attendanceGrid" class="space-y-8"></div>

  <script>
    const months = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];

    const today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();

    function daysInMonth(month, year) {
      return new Date(year, month + 1, 0).getDate();
    }

    function renderMonthSelector() {
      const selector = document.getElementById("monthSelector");
      selector.innerHTML = "";

      months.forEach((m, i) => {
        const btn = document.createElement("button");
        btn.className = `month-btn ${i === currentMonth ? 'bg-indigo-700' : 'bg-gray-700 hover:bg-gray-600'}`;
        btn.textContent = `${m} ${currentYear}`;
        btn.onclick = () => {
          currentMonth = i;
          renderMonthSelector();
          loadAttendance();
        };
        selector.appendChild(btn);
      });
    }

    async function loadAttendance() {
      const container = document.getElementById("attendanceGrid");
      container.innerHTML = "";

      const response = await fetch(`${url}?month=${currentMonth + 1}&year=${currentYear}`);

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Server responded with ${response.status}: ${errorText}`);
      }

      const json = await response.json();

      let data = [];

      try {
        const response = await fetch(`${url}?month=${currentMonth + 1}&year=${currentYear}`);
        const json = await response.json();
        data = json.data || [];
        console.log("‚úÖ Fetched attendance data:", data);
      } catch (e) {
        console.error("‚ùå Failed to load attendance data:", e);
        container.innerHTML = `<p class="text-red-500 text-center">Unable to load attendance data. Check server logs or network connection.</p>`;
        return;
      }

      data.forEach(emp => {
        const row = document.createElement("div");
        row.className = "bg-gray-800 p-4 rounded border border-gray-700";

        const title = document.createElement("p");
        title.className = "text-sm mb-2 font-semibold";
        title.innerHTML = `Name: ${emp.name} | Role: ${emp.role} | Active From: ${emp.from}`;
        row.appendChild(title);

        for (let day = 0; day < days; day++) {
          const dayRow = document.createElement("div");
          dayRow.className = "flex items-center mb-1";

          const label = document.createElement("div");
          label.className = "w-10 text-xs text-gray-400 mr-2";
          label.textContent = `${day + 1}`;
          dayRow.appendChild(label);

          const halfHours = emp.status[day] || Array(48).fill("NA");
          halfHours.forEach(code => {
            const box = document.createElement("div");
            box.className = `half-hour-box ${code || 'NA'}`;
            dayRow.appendChild(box);
          });

          row.appendChild(dayRow);
        }

        container.appendChild(row);
      });
    }

    renderMonthSelector();
    loadAttendance();
  </script>
</body>
</html>
