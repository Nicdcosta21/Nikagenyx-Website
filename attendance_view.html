<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Date View - Nikagenyx</title>
  <script src="/assets/js/auth-gate.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Questrial', sans-serif;
      background-color: #0f172a;
      color: #e0e7ff;
      margin: 0;
      padding: 2rem;
      min-height: 100vh;
    }
    h1 {
      font-weight: 700;
      font-size: 2.5rem;
      margin-bottom: 2rem;
      text-align: center;
      color: #c7d2fe;
      text-shadow: 0 0 6px rgba(79, 70, 229, 0.7);
    }
    .month-btn, .date-btn {
      background-color: #1e293b;
      color: #e0e7ff;
      padding: 0.4rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      margin: 2px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }
    .month-btn:hover, .date-btn:hover {
      background-color: #334155;
    }
    .month-btn.active, .date-btn.active {
      background-color: #6366f1;
      color: white;
    }
    .half-hour-box {
      width: 12px;
      height: 24px;
      margin: 1px;
      border-radius: 3px;
      display: inline-block;
      cursor: pointer;
      transition: all 0.1s ease;
    }
    .half-hour-box:hover {
      transform: scale(1.1);
    }
    .P { background-color: #22c55e; }
    .A { background-color: #ef4444; }
    .L { background-color: #facc15; }

    .row-green { background-color: #15803d33; }
    .row-yellow { background-color: #facc1533; }
    .row-red { background-color: #ef444433; }

    .block-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      margin-top: 0.25rem;
    }
    
    .confirm-btn {
      background-color: #6366f1;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      margin-top: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    .confirm-btn:hover {
      background-color: #4f46e5;
      transform: translateY(-1px);
    }
    
    .employee-row {
      background-color: #1e293b;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .time-label {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>ðŸ“… Employee Attendance - Date View</h1>
  <div id="monthSelector" class="flex flex-wrap justify-center gap-2 mb-4"></div>
  <div id="dateSelector" class="flex flex-wrap justify-center gap-1 mb-4"></div>
  <div class="text-center mb-4">
    <label class="mr-2">Drag Mode:</label>
    <select id="dragMode" class="bg-gray-800 text-white p-1 rounded border border-gray-700">
      <option value="P">Present</option>
      <option value="L">Leave</option>
      <option value="A">Absent</option>
    </select>
  </div>
  <div id="attendanceGrid"></div>
  
<script>
  const months = [...Array(12)].map((_, i) => new Date(0, i).toLocaleString('default', { month: 'long' }));
  const today = new Date();
  let currentMonth = today.getMonth();
  let currentYear = today.getFullYear();
  let selectedDate = today.getDate();
  let mouseDown = false;
  let employees = [];
  let dragStatus = "P";

  document.addEventListener("mousedown", () => mouseDown = true);
  document.addEventListener("mouseup", () => mouseDown = false);
  document.getElementById("dragMode").onchange = e => dragStatus = e.target.value;

  function formatAMPM(index) {
    const hour = Math.floor(index / 2);
    const minute = index % 2 === 0 ? '00' : '30';
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const formattedHour = hour % 12 === 0 ? 12 : hour % 12;
    return `${formattedHour}:${minute} ${ampm}`;
  }

  function daysInMonth(month, year) {
    return new Date(year, month + 1, 0).getDate();
  }

  function renderMonthSelector() {
    const container = document.getElementById("monthSelector");
    container.innerHTML = "";
    months.forEach((m, i) => {
      const btn = document.createElement("button");
      btn.textContent = `${m} ${currentYear}`;
      btn.className = `month-btn ${i === currentMonth ? "active" : ""}`;
      btn.onclick = () => {
        currentMonth = i; 
        selectedDate = 1;
        renderMonthSelector(); 
        renderDateSelector(); 
        loadAttendance();
      };
      container.appendChild(btn);
    });
  }

  function renderDateSelector() {
    const container = document.getElementById("dateSelector");
    container.innerHTML = "";
    for (let d = 1; d <= daysInMonth(currentMonth, currentYear); d++) {
      const btn = document.createElement("button");
      btn.textContent = d;
      btn.className = `date-btn ${d === selectedDate ? "active" : ""}`;
      btn.onclick = () => { 
        selectedDate = d; 
        renderDateSelector(); 
        loadAttendance(); 
      };
      container.appendChild(btn);
    }
  }

  function updateEmployeeSummary(empId) {
    const emp = employees.find(e => e.emp_id === empId);
    if (!emp) return;

    const summary = { P: 0, A: 0, L: 0 };
    emp.blockStates.forEach(state => {
      const finalState = ["P", "L", "A"].includes(state) ? state : "A";
      summary[finalState] = (summary[finalState] || 0) + 1;
    });

    const totalHours = summary.P * 0.5;
    const totalAbsent = summary.A + summary.L;
    const row = document.getElementById(`row-${empId}`);
    if (!row) return;

    const info = row.querySelector('.info-text');
    if (info) {
      info.textContent = `P: ${summary.P} | A: ${totalAbsent} â†’ ${totalHours.toFixed(2)} hrs`;
    }

    row.classList.remove("row-red", "row-yellow", "row-green");
    if (totalHours < 5) row.classList.add("row-red");
    else if (totalHours < 7) row.classList.add("row-yellow");
    else row.classList.add("row-green");
  }

  function toggleBlock(box, empId) {
    const current = box.dataset.state;
    const next = current === dragStatus ? "A" : dragStatus;
    box.dataset.state = next;
    box.className = `half-hour-box ${next}`;

    const index = parseInt(box.dataset.index);
    const emp = employees.find(e => e.emp_id === empId);
    if (emp) {
      emp.blockStates[index] = next;
      updateEmployeeSummary(empId);
    }
  }

  function dragToggleBlock(box, empId) {
    if (!mouseDown) return;
    const current = box.dataset.state;
    const newState = current === dragStatus ? "A" : dragStatus;
    const index = parseInt(box.dataset.index);
    const emp = employees.find(e => e.emp_id === empId);
    if (!emp) return;
    box.dataset.state = newState;
    box.className = `half-hour-box ${newState}`;
    emp.blockStates[index] = newState;
    updateEmployeeSummary(empId);
  }

  async function loadAttendance() {
    const grid = document.getElementById("attendanceGrid");
    grid.innerHTML = "Loading...";
    
    try {
      const res = await fetch(`/.netlify/functions/get_attendance_calendar?month=${currentMonth + 1}&year=${currentYear}`);
      const { data } = await res.json();
      employees = data;
      grid.innerHTML = "";

      if (!data || data.length === 0) {
        grid.innerHTML = "<div class='text-center text-gray-400'>No attendance data found for this month</div>";
        return;
      }

      data.forEach(emp => {
        const row = document.createElement("div");
        row.className = "employee-row p-4 mb-4 rounded shadow";
        row.id = `row-${emp.emp_id}`;

        const title = document.createElement("div");
        title.className = "font-bold mb-2 text-lg";
        title.textContent = `${emp.name} (${emp.role}) - ${emp.department}`;
        row.appendChild(title);

        const blocks = emp.status[selectedDate - 1]?.blocks || Array(48).fill("A");
        emp.blockStates = [...blocks];

        const blockWrap = document.createElement("div");
        blockWrap.className = "block-wrap";

        // Add time labels at the bottom
        const timeLabels = document.createElement("div");
        timeLabels.className = "flex justify-between time-label";
        timeLabels.innerHTML = `
          <span>12 AM</span>
          <span>6 AM</span>
          <span>12 PM</span>
          <span>6 PM</span>
          <span>12 AM</span>
        `;
        
        emp.blockStates.forEach((state, i) => {
          const finalState = ["P", "L", "A"].includes(state) ? state : "A";
          const box = document.createElement("div");
          box.className = `half-hour-box ${finalState}`;
          box.dataset.index = i;
          box.dataset.state = finalState;
          box.title = `${formatAMPM(i)} - ${finalState === 'P' ? 'Present' : finalState === 'L' ? 'Leave' : 'Absent'}`;

          box.onclick = () => toggleBlock(box, emp.emp_id);
          box.onmouseover = () => dragToggleBlock(box, emp.emp_id);
          blockWrap.appendChild(box);
        });

        row.appendChild(blockWrap);
        row.appendChild(timeLabels);

        const info = document.createElement("div");
        info.className = "text-sm mt-2 text-gray-300 info-text";
        row.appendChild(info);

        const btn = document.createElement("button");
        btn.textContent = "Confirm Changes";
        btn.className = "confirm-btn";
        btn.onclick = () => submit(emp.emp_id);
        row.appendChild(btn);

        updateEmployeeSummary(emp.emp_id);
        grid.appendChild(row);
      });
    } catch (error) {
      console.error("Error loading attendance:", error);
      grid.innerHTML = `<div class="text-center text-red-400">Error loading attendance data: ${error.message}</div>`;
    }
  }

  async function submit(empId) {
    const emp = employees.find(e => e.emp_id === empId);
    if (!emp) {
      alert("Employee not found!");
      return;
    }

    const slots = emp.blockStates.map((state, i) => ({ 
      slot: i, 
      status: ["P", "L", "A"].includes(state) ? state : "A" 
    }));

    try {
      const res = await fetch("/.netlify/functions/update_attendance", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          emp_id: empId,
          year: currentYear,
          month: currentMonth + 1,
          day: selectedDate,
          slots
        })
      });
      
      const result = await res.json();
      if (res.ok) {
        alert("Attendance updated successfully!");
        loadAttendance();
      } else {
        alert(`Error: ${result.error || "Failed to update attendance"}`);
      }
    } catch (error) {
      console.error("Error submitting attendance:", error);
      alert("Failed to update attendance. Please try again.");
    }
  }

  // Initialize
  renderMonthSelector();
  renderDateSelector();
  loadAttendance();
</script>
</body>
</html>
