<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employee Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="/assets/js/auth-gate.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Dark Mode Toggle -->
  <div class="absolute top-4 left-4 z-50">
    <button onclick="toggleDarkMode()" class="bg-gray-700 px-4 py-2 rounded hover:bg-gray-600">Toggle Dark Mode</button>
  </div>

  <!-- Navbar -->
  <nav class="bg-gray-800 p-4 flex flex-wrap justify-between items-center text-sm">
    <div class="text-xl font-bold">Nikagenyx</div>
    <div class="flex gap-4 flex-wrap mt-2 sm:mt-0">
      <a href="update_profile.html">Update Profile</a>
      <a href="view_attendance.html">My Attendance</a>
      <a href="payroll_portal.html">Payroll</a>
      <button onclick="logout()" class="bg-red-600 px-3 py-1 rounded">Logout</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-grow flex flex-col items-center px-4 py-8 space-y-8">
    <h1 class="text-3xl font-semibold">
      Welcome, <span id="empName">Employee</span>
    </h1>

    <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Clock In/Out Card -->
      <div class="bg-gray-800 rounded-xl p-6">
        <h2 class="text-xl font-bold mb-6 text-center">Clock In / Clock Out</h2>
        <div class="space-y-4">
          <button id="clockInBtn" onclick="clockIn()" class="w-full bg-green-600 hover:bg-green-700 px-4 py-3 rounded-lg disabled:opacity-50 text-lg font-medium">
            Clock In
          </button>
          <button id="clockOutBtn" onclick="clockOut()" class="w-full bg-yellow-600 hover:bg-yellow-700 px-4 py-3 rounded-lg disabled:opacity-50 text-lg font-medium">
            Clock Out
          </button>
        </div>
        <p id="statusMessage" class="text-center text-gray-400 mt-4">
          Already clocked out or not clocked in yet.
        </p>
      </div>

      <!-- Today's Summary Card -->
      <div class="bg-gray-800 rounded-xl p-6">
        <h2 class="text-xl font-bold mb-6 text-center">Today's Summary</h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-blue-600 p-4 rounded-lg">
            <p class="text-sm">Clock In</p>
            <p id="todayClockIn" class="font-bold text-xl mt-1">--:--</p>
          </div>
          <div class="bg-purple-600 p-4 rounded-lg">
            <p class="text-sm">Clock Out</p>
            <p id="todayClockOut" class="font-bold text-xl mt-1">--:--</p>
          </div>
          <div class="bg-green-600 p-4 rounded-lg">
            <p class="text-sm">Hours Worked</p>
            <p id="todayHours" class="font-bold text-xl mt-1">0h 0m</p>
          </div>
          <div class="bg-yellow-500 p-4 rounded-lg">
            <p class="text-sm">Status</p>
            <p id="todayStatus" class="font-bold text-xl mt-1">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions + Performance Metrics -->
    <div class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Quick Links Panel -->
      <div class="bg-gray-800 rounded-xl p-6">
        <h2 class="text-xl font-bold mb-6 text-center">Quick Actions</h2>
        <div class="grid grid-cols-2 gap-4">
          <a href="update_profile.html" class="bg-indigo-600 hover:bg-indigo-700 p-4 rounded-lg text-center transition transform hover:-translate-y-1">
            Update Profile
          </a>
          <a href="payroll_portal.html" class="bg-green-600 hover:bg-green-700 p-4 rounded-lg text-center transition transform hover:-translate-y-1">
            Payroll
          </a>
          <a href="view_attendance.html" class="bg-blue-600 hover:bg-blue-700 p-4 rounded-lg text-center transition transform hover:-translate-y-1">
            Attendance
          </a>
          <button onclick="showLeaveModal()" class="bg-yellow-600 hover:bg-yellow-700 p-4 rounded-lg transition transform hover:-translate-y-1">
            Apply Leave
          </button>
        </div>
      </div>

      <!-- Performance Metrics -->
      <div class="bg-gray-800 rounded-xl p-6">
        <h2 class="text-xl font-bold mb-6 text-center">This Month</h2>
        <div class="space-y-6">
          <div>
            <div class="flex justify-between mb-2">
              <span>Attendance</span>
              <span id="attendanceRatio" class="font-medium">0/0 days</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3">
              <div id="attendanceBar" class="bg-green-600 h-3 rounded-full" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between mb-2">
              <span>Productivity</span>
              <span id="productivityScore" class="font-medium">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3">
              <div id="productivityBar" class="bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity Feed -->
    <div class="w-full max-w-4xl bg-gray-800 rounded-xl p-6">
      <h2 class="text-xl font-bold mb-6 text-center">Recent Activity</h2>
      <ul id="activityFeed" class="space-y-3">
        <li class="text-center text-gray-400 py-4">Loading activities...</li>
      </ul>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-gray-500 text-center py-4 text-xs">
    &copy; 2025 Nikagenyx Vision Tech Pvt. Ltd.
  </footer>

  <script>
    // ======================
    // MAIN DASHBOARD CONTROLLER
    // ======================
    document.addEventListener("DOMContentLoaded", async () => {
      // 1. Check session and get employee ID
      const empSession = JSON.parse(localStorage.getItem("emp_session"));
      const empId = empSession?.emp_id;
      
      if (!empId) {
        window.location.href = "employee_portal.html";
        return;
      }

      // 2. Set employee name in header
      document.getElementById("empName").textContent = empSession?.name || "Employee";

      // 3. Initialize all dashboard components
      initClockSystem(empId);
      loadDashboardData(empId);
      setupAutoClockOutCheck();
      setupEventListeners();
    });

    // ======================
    // CLOCK IN/OUT SYSTEM
    // ======================
    function initClockSystem(empId) {
      const clockInBtn = document.getElementById("clockInBtn");
      const clockOutBtn = document.getElementById("clockOutBtn");
      const status = document.getElementById("statusMessage");

      // Check current clock status on load
      checkClockStatus();

      function checkClockStatus() {
        fetch(`/.netlify/functions/get_clock_status?emp_id=${empId}`)
          .then(res => res.json())
          .then(data => {
            updateButtonState(data.last_action);
            status.textContent = data.message || "Ready to clock in";
          });
      }

      function updateButtonState(lastAction) {
        clockInBtn.disabled = lastAction === "in";
        clockOutBtn.disabled = lastAction !== "in";
        
        clockInBtn.classList.toggle("opacity-50", lastAction === "in");
        clockOutBtn.classList.toggle("opacity-50", lastAction !== "in");
      }

      // Clock in/out handlers
      window.clockIn = () => markAttendance("in");
      window.clockOut = () => markAttendance("out");

      function markAttendance(type) {
        fetch("/.netlify/functions/mark_attendance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ emp_id: empId, type })
        })
        .then(res => res.json())
        .then(data => {
          status.textContent = data.message;
          updateButtonState(type);
          loadDashboardData(empId); // Refresh dashboard
        })
        .catch(err => {
          status.textContent = "Error recording attendance";
          console.error(err);
        });
      }
    }

    // ======================
    // DASHBOARD DATA LOADER
    // ======================
    async function loadDashboardData(empId) {
      try {
        const res = await fetch(`/.netlify/functions/get_dashboard_data?emp_id=${empId}`);
        if (!res.ok) throw new Error("Failed to fetch data");
        const data = await res.json();
        
        updateTodaySummary(data.today);
        updatePerformanceMetrics(data.metrics);
        updateActivityFeed(data.activities);
        
      } catch (err) {
        console.error("Dashboard error:", err);
        showToast("Failed to load dashboard data", true);
      }
    }

    function updateTodaySummary(todayData) {
      if (!todayData) return;
      
      document.getElementById('todayClockIn').textContent = todayData.clock_in || '--:--';
      document.getElementById('todayClockOut').textContent = todayData.clock_out || '--:--';
      document.getElementById('todayHours').textContent = todayData.hours_worked || '0h 0m';
      
      // Set status with color coding
      const statusElem = document.getElementById('todayStatus');
      statusElem.textContent = todayData.status || '-';
      statusElem.className = "font-bold text-xl mt-1 " + (
        todayData.status === "Late" ? "text-yellow-400" :
        todayData.status === "Absent" ? "text-red-400" :
        "text-green-400"
      );
    }

    // Update in updatePerformanceMetrics function
function updatePerformanceMetrics(metrics) {
  if (!metrics) return;
  
  // Attendance - Handle division by zero
  let attendancePercent = 0;
  if (metrics.working_days > 0) {
    attendancePercent = Math.min(
      100,
      Math.round((metrics.attendance_days / metrics.working_days) * 100) || 0
    );
  }
  
  document.getElementById('attendanceRatio').textContent = 
    `${metrics.attendance_days}/${metrics.working_days} days`;
  document.getElementById('attendanceBar').style.width = `${attendancePercent}%`;
  
  // Productivity
  const productivity = Math.min(100, metrics.productivity || 0);
  document.getElementById('productivityScore').textContent = `${productivity}%`;
  document.getElementById('productivityBar').style.width = `${productivity}%`;
}
    
    function updateActivityFeed(activities) {
      const feed = document.getElementById('activityFeed');
      if (!activities?.length) {
        feed.innerHTML = `<li class="text-center text-gray-400 py-4">No recent activities</li>`;
        return;
      }

      feed.innerHTML = activities.map(activity => `
        <li class="flex items-start gap-3 p-3 hover:bg-gray-700 rounded-lg transition-colors">
          <div class="mt-1.5 flex-shrink-0 w-2 h-2 rounded-full ${
            activity.type === 'clock' ? 'bg-green-500' : 
            activity.type === 'profile' ? 'bg-blue-500' : 
            activity.type === 'leave' ? 'bg-yellow-500' : 'bg-purple-500'
          }"></div>
          <div class="flex-grow">
            <p class="text-sm">${activity.message}</p>
            <p class="text-xs text-gray-400">${formatActivityTime(activity.timestamp)}</p>
          </div>
        </li>
      `).join('');
    }

    // ======================
    // UTILITY FUNCTIONS
    // ======================
    function formatActivityTime(timestamp) {
      const now = new Date();
      const activityDate = new Date(timestamp);
      const diffHours = Math.floor((now - activityDate) / (1000 * 60 * 60));
      
      if (diffHours < 1) {
        return "Just now";
      } else if (diffHours < 24) {
        return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      } else if (diffHours < 48) {
        return "Yesterday";
      } else {
        return activityDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
      }
    }

    function setupAutoClockOutCheck() {
      function checkInactivity() {
        const lastAction = localStorage.getItem("last_action");
        const lastActivity = parseInt(localStorage.getItem("last_activity"), 10) || 0;
        
        if (lastAction === "in" && Date.now() - lastActivity > 1800000) { // 30 minutes
          markAttendance("out");
          document.getElementById("statusMessage").textContent = "Auto clocked out due to inactivity";
        }
      }

      // Track user activity
      ['mousemove', 'keydown', 'click'].forEach(event => {
        document.addEventListener(event, () => {
          localStorage.setItem("last_activity", Date.now());
        });
      });

      // Check every minute
      setInterval(checkInactivity, 60000);
    }

    // ======================
    // EVENT LISTENERS
    // ======================
    function setupEventListeners() {
      // Leave Application Modal
      window.showLeaveModal = () => {
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.id = "leaveModal"; // Add ID for easy removal
        
        modal.innerHTML = `
          <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Apply for Leave</h3>
            <form id="leaveForm" class="space-y-4">
              <div>
                <label class="block mb-1 text-sm">Leave Type</label>
                <select name="type" class="w-full px-3 py-2 bg-gray-700 rounded border border-gray-600">
                  <option value="sick">Sick Leave</option>
                  <option value="casual">Casual Leave</option>
                  <option value="emergency">Emergency Leave</option>
                </select>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-sm">From Date</label>
                  <input type="date" name="from" class="w-full px-3 py-2 bg-gray-700 rounded border border-gray-600">
                </div>
                <div>
                  <label class="block mb-1 text-sm">To Date</label>
                  <input type="date" name="to" class="w-full px-3 py-2 bg-gray-700 rounded border border-gray-600">
                </div>
              </div>
              <div>
                <label class="block mb-1 text-sm">Reason</label>
                <textarea name="reason" rows="3" class="w-full px-3 py-2 bg-gray-700 rounded border border-gray-600"></textarea>
              </div>
              <div class="flex justify-end gap-2 mt-4">
                <button type="button" onclick="document.getElementById('leaveModal').remove()" 
                  class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded">Cancel</button>
                <button type="submit" 
                  class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded">Submit</button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        modal.querySelector("input[name='from']").min = today;
        modal.querySelector("input[name='to']").min = today;
        
        modal.querySelector("#leaveForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          
          try {
            const res = await fetch("/.netlify/functions/apply_leave", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                emp_id: JSON.parse(localStorage.getItem("emp_session")).emp_id,
                ...Object.fromEntries(formData)
              })
            });
            
            const result = await res.json();
            showToast(result.message || "Leave application submitted");
            modal.remove();
            loadDashboardData(JSON.parse(localStorage.getItem("emp_session")).emp_id);
          } catch (err) {
            showToast("Failed to submit leave application", true);
            console.error(err);
          }
        });
      };

      // Logout function
      window.logout = () => {
        localStorage.removeItem("emp_session");
        window.location.href = "employee_portal.html";
      };
    }

    // ======================
    // TOAST NOTIFICATIONS
    // ======================
    function showToast(message, isError = false) {
      const toast = document.createElement("div");
      toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
        isError ? "bg-red-600" : "bg-green-600"
      } text-white animate-fade-in`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add("animate-fade-out");
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Add animation styles
    document.head.insertAdjacentHTML("beforeend", `
      <style>
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out {
          from { opacity: 1; transform: translateY(0); }
          to { opacity: 0; transform: translateY(10px); }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-fade-out { animation: fade-out 0.3s ease-in; }
      </style>
    `);
  </script>

  <script>
    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('bg-gray-900');
      body.classList.toggle('bg-white');
      body.classList.toggle('text-white');
      body.classList.toggle('text-black');
    }
  </script>

</body>
</html>
