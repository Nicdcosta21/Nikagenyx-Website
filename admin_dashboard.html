<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Nikagenyx</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Questrial', sans-serif; }
    .section-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

<script>
  const session = localStorage.getItem("emp_session");
  let currentUser = null;
  if (!session) {
    window.location.href = "employee_portal.html";
  } else {
    currentUser = JSON.parse(session);
    if (currentUser.role !== "admin") {
      window.location.href = "employee_dashboard.html";
    }
  }
</script>

<nav class="w-full bg-gray-800 px-6 py-4 flex items-center justify-between">
  <a href="index.html" class="text-2xl font-bold text-white">Nikagenyx</a>
  <ul class="flex gap-6 text-sm">
    <li><a href="employee_portal.html" class="hover:text-purple-400">Employee Portal</a></li>
    <li><a href="register_employee.html" class="hover:text-purple-400">Register</a></li>
    <li><a href="update_profile.html" class="hover:text-purple-400">Update Profile</a></li>
    <li><a href="payroll_portal.html" class="hover:text-purple-400">Payroll</a></li>
    <li><button onclick="logout()" class="bg-red-600 px-4 py-1 rounded">Logout</button></li>
  </ul>
</nav>

<main class="p-6 max-w-7xl mx-auto flex-grow">
  <h1 class="text-3xl font-bold mb-4">Admin Dashboard</h1>
  <p class="mb-4 text-gray-300">Welcome, <span id="adminName">Admin</span> ðŸ‘‹</p>

  <!-- Admin Profile Panel -->
  <section id="adminProfile" class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-10">
    <h2 class="section-title border-b border-gray-600 pb-2 mb-4">ðŸ‘¤ My Admin Profile</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
      <div><strong>Name:</strong> <span id="p_name">-</span></div>
      <div><strong>Phone:</strong> <span id="p_phone">-</span></div>
      <div><strong>Date of Birth:</strong> <span id="p_dob">-</span></div>
      <div><strong>Department:</strong> <span id="p_dept">-</span></div>
      <div><strong>Role:</strong> <span id="p_role">-</span></div>
    </div>
    <div class="mt-4 space-x-3">
      <a href="update_profile.html" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm">Update Profile</a>
      <a href="index.html" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">View Attendance</a>
      <a href="payroll_portal.html" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">Payroll Portal</a>
    </div>
  </section>

  <!-- Attendance Summary -->
  <section id="attendanceSummary" class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-10">
    <h2 class="section-title border-b border-gray-600 pb-2 mb-4">ðŸ“… Attendance Overview</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full table-auto text-sm">
        <thead class="bg-gray-700">
          <tr>
            <th class="p-2 border">Date</th>
            <th class="p-2 border">Clock In</th>
            <th class="p-2 border">Clock Out</th>
            <th class="p-2 border">Hours Worked</th>
          </tr>
        </thead>
        <tbody id="attendanceTable" class="text-center"></tbody>
        <tfoot>
          <tr class="bg-gray-700 text-sm">
            <td colspan="3" class="p-2 text-right font-bold">Total Hours:</td>
            <td id="totalHours" class="p-2">-</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <!-- Notification Sender -->
  <section id="notifyBox" class="bg-gray-800 border border-gray-700 rounded-lg p-6">
    <h2 class="section-title border-b border-gray-600 pb-2 mb-4">ðŸ“¢ Send Notification</h2>
    <input type="text" id="notifEmpId" placeholder="Emp ID (or 'all')" class="w-full mb-3 p-2 bg-gray-700 border border-gray-600 rounded text-sm" />
    <textarea id="notifMessage" rows="3" placeholder="Type your message here..." class="w-full mb-4 p-2 bg-gray-700 border border-gray-600 rounded text-sm"></textarea>
    <button onclick="sendNotification()" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded text-sm">Send</button>
  </section>
</main>

<footer class="bg-gray-800 text-gray-500 text-center py-6 text-sm">
  &copy; 2025 Nikagenyx Vision Tech Private Limited. All rights reserved.
</footer>

<script>
function logout() {
  localStorage.removeItem("emp_session");
  window.location.href = "employee_portal.html";
}

function sendNotification() {
  const emp_id = document.getElementById("notifEmpId").value.trim();
  const message = document.getElementById("notifMessage").value.trim();
  if (!emp_id || !message) return alert("Fill in all fields");

  fetch("/.netlify/functions/send_notification", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ emp_id, message })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message || "Notification sent");
    document.getElementById("notifEmpId").value = "";
    document.getElementById("notifMessage").value = "";
  })
  .catch(err => {
    console.error("Failed to send notification", err);
    alert("Error sending notification");
  });
}

window.onload = () => {
  const user = JSON.parse(localStorage.getItem("emp_session"));

  fetch("/.netlify/functions/get_employee_profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ emp_id: user.emp_id })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("adminName").textContent = data.name;
    document.getElementById("p_name").textContent = data.name || "-";
    document.getElementById("p_phone").textContent = data.phone || "-";
    document.getElementById("p_dob").textContent = data.dob || "-";
    document.getElementById("p_dept").textContent = data.department || "-";
    document.getElementById("p_role").textContent = data.role || "-";
  });

  fetch("/.netlify/functions/get_attendance", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ emp_id: user.emp_id })
  })
  .then(res => res.json())
  .then(data => {
    const table = document.getElementById("attendanceTable");
    let total = 0;
    table.innerHTML = "";
    data.attendance.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border p-2">${row.date}</td>
        <td class="border p-2">${row.clock_in || '-'}</td>
        <td class="border p-2">${row.clock_out || '-'}</td>
        <td class="border p-2">${row.hours_worked?.toFixed(2) || '-'}</td>
      `;
      if (row.hours_worked) total += parseFloat(row.hours_worked);
      table.appendChild(tr);
    });
    document.getElementById("totalHours").textContent = total.toFixed(2);
  });
};
</script>

</body>
</html>
