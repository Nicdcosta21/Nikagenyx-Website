<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Nikagenyx</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Questrial', sans-serif; }
    .section-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; }
    select { position: relative; z-index: 10; }
    select {
  appearance: none;
  background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='16' viewBox='0 0 24 24' width='16' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 0.5rem center;
  background-size: 1rem;
}
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
  
<script>
  const session = localStorage.getItem("emp_session");
  let currentUser = null;
  if (!session) {
    window.location.href = "employee_portal.html";
  } else {
    currentUser = JSON.parse(session);
    if (currentUser.role !== "admin") {
      window.location.href = "employee_dashboard.html";
    }
  }
</script>


<nav class="w-full bg-gray-800 px-6 py-4 flex items-center justify-between">
  <a href="index.html" class="text-2xl font-bold text-white">Nikagenyx</a>
  <ul class="flex gap-6 text-sm">
    <li><a href="employee_portal.html" class="hover:text-purple-400">Employee Portal</a></li>
    <li><a href="register_employee.html" class="hover:text-purple-400">Register</a></li>
    <li><a href="update_profile.html" class="hover:text-purple-400">Update Profile</a></li>
    <li><a href="payroll_portal.html" class="hover:text-purple-400">Payroll</a></li>
    <li><button onclick="logout()" class="bg-red-600 px-4 py-1 rounded">Logout</button></li>
  </ul>
</nav>
  
<main class="p-6 max-w-7xl mx-auto flex-grow">
  <h1 class="text-3xl font-bold mb-4">Admin Dashboard</h1>
  <p class="mb-4 text-gray-300">Welcome, <span id="adminName">Admin</span> ðŸ‘‹</p>

  <div class="mb-4 flex flex-col md:flex-row gap-4">
    <input id="search" type="text" placeholder="Search by name or ID" class="p-2 bg-gray-800 border border-gray-600 rounded w-full md:w-1/3">
    <button onclick="exportCSV()" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">Export CSV</button>
  </div>

  <div class="overflow-x-auto mb-10">
    <table class="min-w-full table-auto bg-gray-800 border border-gray-700">
      <thead class="bg-gray-700">
        <tr>
          <th class="p-2 border">ID</th>
          <th class="p-2 border">Name</th>
          <th class="p-2 border">Phone</th>
          <th class="p-2 border">DOB</th>
          <th class="p-2 border">Role</th>
          <th class="p-2 border">Department</th>
          <th class="p-2 border">Actions</th>
        </tr>
      </thead>
      <tbody id="employeeTable" class="text-center text-sm"></tbody>
    </table>
  </div>
 <div class="my-4 bg-gray-800 p-4 rounded border border-gray-600 flex items-center gap-4">
  <label for="payrollToggle" class="text-white text-sm">Payroll Mode:</label>
  <select id="payrollToggle" class="bg-gray-900 text-white border border-gray-600 px-3 py-2 rounded outline-none focus:ring-2 focus:ring-purple-500 appearance-none">
  <option value="freelance">Freelance</option>
  <option value="fulltime">Full-Time</option>
</select>
  <button id="confirmPayroll" class="bg-blue-600 hover:bg-blue-700 px-4 py-1 rounded text-sm">Confirm</button>
  <span id="toggleStatus" class="ml-4 text-green-400 text-sm"></span>
</div>



  <section id="adminProfile" class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-10">
    <h2 class="section-title border-b border-gray-600 pb-2 mb-4">ðŸ‘¤ My Admin Profile</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
      <div><strong>Name:</strong> <span id="p_name">-</span></div>
      <div><strong>Phone:</strong> <span id="p_phone">-</span></div>
      <div><strong>Date of Birth:</strong> <span id="p_dob">-</span></div>
      <div><strong>Department:</strong> <span id="p_dept">-</span></div>
      <div><strong>Role:</strong> <span id="p_role">-</span></div>
    </div>
    <div class="mt-4 space-x-3">
      <a href="update_profile.html" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm">Update Profile</a>
      <a href="attendance_view.html" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">View Attendance</a>
      <a href="payroll_portal.html" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">Payroll Portal</a>
    </div>
  </section>
</main>

<footer class="bg-gray-800 text-gray-500 text-center py-6 text-sm">
  &copy; 2025 Nikagenyx Vision Tech Private Limited. All rights reserved.
</footer>

<script>
// JavaScript for Admin Dashboard

function logout() {
  localStorage.removeItem("emp_session");
  window.location.href = "employee_portal.html";
}

function formatDate(dob) {
  return new Date(dob).toISOString().split("T")[0];
}

function exportCSV() {
  alert("CSV export triggered (placeholder).");
}

function changeRole(empId, newRole) {
  fetch("/.netlify/functions/update_role", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ emp_id: empId, role: newRole })
  })
  .then(res => res.json())
  .then(data => {
    alert(`âœ… Role updated to ${newRole.toUpperCase()} for ${empId}`);
  })
  .catch(err => {
    console.error("Role change failed:", err);
    alert("âŒ Failed to change role.");
  });
}

function showToast(msg) {
  const toast = document.createElement('div');
  toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50';
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function viewEmployeeDetails(empId) {
  localStorage.setItem("selected_emp_id", empId);
  window.location.href = "employee_profile.html";
}

function submitEdit(emp_id, name) {
  const phone = document.getElementById("editPhone").value;
  const dob = document.getElementById("editDob").value;
  const role = document.getElementById("editRole").value;
  const department = document.getElementById("editDept").value;
  const base_salary = document.getElementById("editSalary").value;

  fetch("/.netlify/functions/update_employee_profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ emp_id, name, phone, dob, role, department, base_salary })
  })
  .then(res => res.json())
  .then(data => {
    showToast(data.message || "Profile updated");
    document.querySelector(".fixed").remove();
    setTimeout(() => location.reload(), 1000);
  })
  .catch(err => {
    console.error("Edit failed:", err);
    alert("âŒ Failed to update profile");
  });
}

  

function setupPayrollConfirm() {
  document.getElementById("confirmPayroll").addEventListener("click", async () => {
    const selected = document.getElementById("payrollToggle").value;
    const res = await fetch("/.netlify/functions/set_payroll_mode", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: selected })
    });
    const data = await res.json();
    document.getElementById("toggleStatus").textContent = `${selected}`;
    showToast(data.message || `Payroll mode updated`);
  });
}

async function loadPayrollMode() {
  const res = await fetch("/.netlify/functions/get_payroll_mode");
  const data = await res.json();
  const toggle = document.getElementById("payrollToggle");
  const status = document.getElementById("toggleStatus");
  toggle.value = data.mode || "freelance";
  status.textContent = `${data.mode === 'freelance' ? 'Freelance payroll mode is currently active' : 'Full-time payroll mode is currently active'}`;
  setupPayrollConfirm();
}

function showProfilePopup(empId) {
  fetch("/.netlify/functions/get_employee_profile?emp_id=" + empId)
    .then(res => res.json())
    .then(emp => {
      const modal = document.createElement("div");
      modal.className = "fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center";
      modal.innerHTML = `
        <div class="bg-white text-black p-6 rounded shadow-lg max-w-lg w-full">
          <h2 class="text-xl font-semibold mb-4">Employee: ${emp.name}</h2>
          <p><strong>ID:</strong> ${emp.emp_id}</p>
          <p><strong>Phone:</strong> ${emp.phone}</p>
          <p><strong>Date of Birth:</strong> ${emp.dob}</p>
          <p><strong>Role:</strong> ${emp.role}</p>
          <p><strong>Department:</strong> ${emp.department}</p>
          <p><strong>Total Pay:</strong> â‚¹${emp.total_pay || 0}</p>
          <p><strong>Total Worked Days:</strong> ${emp.total_days || 0}</p>
          <div class="mt-4">
            <h3 class="font-semibold">Uploaded Files:</h3>
            <ul class="list-disc list-inside text-sm text-blue-600">
              ${(emp.files || []).map(file => `<li><a href="${file.url}" target="_blank">${file.name}</a></li>`).join("")}
            </ul>
          </div>
          <div class="mt-6 text-right">
            <button onclick="this.closest('.fixed').remove()" class="bg-red-600 text-white px-4 py-2 rounded">Close</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
    })
    .catch(() => alert("Failed to load employee details."));
}

window.onload = async () => {
  try {
    const res = await fetch("/.netlify/functions/get_employees");
    const data = await res.json();
    const employees = data.employees || data;
    const table = document.getElementById("employeeTable");

    if (!Array.isArray(employees) || employees.length === 0) {
      showToast("No employees found.");
      return;
    }

    employees.forEach(emp => {
      console.log("Rendering employee:", emp);
      const tr = document.createElement("tr");
tr.innerHTML = `
  <td class="border p-2 text-blue-400 underline cursor-pointer" onclick="showProfilePopup('${emp.emp_id}')">${emp.emp_id}</td>
  <td class="border p-2">${emp.name}</td>
  <td class="border p-2">${emp.phone || '-'}</td>
  <td class="border p-2">${emp.dob ? formatDate(emp.dob) : '-'}</td>
  <td class="border p-2">${emp.role}</td>
  <td class="border p-2">${emp.department || '-'}</td>
  <td class="border p-2 flex flex-wrap gap-1 justify-center">
    <button onclick="viewEmployeeDetails('${emp.emp_id}')" class="bg-purple-600 text-white px-2 py-1 rounded text-xs">View</button>
    <button onclick="changeRole('${emp.emp_id}', '${emp.role === 'admin' ? 'employee' : 'admin'}')" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">Toggle Role</button>
  </td>
`;
table.appendChild(tr);

      // Rendering code for table row is handled inside HTML
    });

    const me = employees.find(e => e.emp_id === currentUser.emp_id);
    if (me) {
      document.getElementById("p_name").textContent = me.name || "-";
      document.getElementById("p_phone").textContent = me.phone || "-";
      document.getElementById("p_dob").textContent = me.dob ? formatDate(me.dob) : "-";
      document.getElementById("p_dept").textContent = me.department || "-";
      document.getElementById("p_role").textContent = me.role || "-";
      document.getElementById("adminName").textContent = me.name || "Admin";
    }
  } catch (err) {
    console.error("Failed to load employees:", err);
  }
};

  
</script>

</body>
</html>
